---
title: "R Notebook"
output: html_notebook
---

This is an [R Markdown](http://rmarkdown.rstudio.com) Notebook. When you execute code within the notebook, the results appear beneath the code. 

Try executing this chunk by clicking the *Run* button within the chunk or by placing your cursor inside it and pressing *Ctrl+Shift+Enter*. 

```{r main aggregation run}

library(data.table)  # For efficient data manipulation and reading
library(parallel)    # For parallel processing
library(bizdays)     # For business days calculation
library(stringr)

###Pull any new data from shared google drive
library(googledrive)

drive_auth(email = "abbrowne@gmail.com")

googledrive_folder_id <- "14d9Yt6JZp6zSYnxxjXEOF87xAQlMGXXx"
files_in_folder <- drive_ls(as_id(googledrive_folder_id))

main_dir <- "E:/Market_Data/DiscountOptionData/DTNSubscription/"

existing_files <- list.files(paste0(main_dir,"Archives/"),pattern = ".zip$")
files_to_download <- files_in_folder$name[!(files_in_folder$name %in% existing_files)]
files_to_download <- files_to_download[order(files_to_download)]

if(length(files_to_download) > 0){
  for(temp_file_i in 1:length(files_to_download)){
    temp_file <- files_to_download[temp_file_i]
    drive_download(temp_file,path=paste0("E:/Market_Data/DiscountOptionData/DTNSubscription/Archives/",temp_file))
    unzip(zipfile=paste0("E:/Market_Data/DiscountOptionData/DTNSubscription/Archives/",temp_file),
          exdir="E:/Market_Data/DiscountOptionData/DTNSubscription/")
  }
}

# Load the external script once, assuming it defines necessary functions
#source("C:/Users/Andy/Downloads/Investing files/Investing_Project_Rstudio/finance_functions.R")

option_chain_aggregatorV3 <- function(input_option_chain, min_strike_ratio=NA, max_strike_ratio=NA, min_avg_days_to_expiry=NA, max_avg_days_to_expiry=NA) {
  # Ensure input_option_chain is a data.table
  setDT(input_option_chain)

  # Check for unique ticker, date, and price
  if (uniqueN(input_option_chain$Symbol) > 1 || uniqueN(input_option_chain$DataDate) > 1 || uniqueN(input_option_chain$UnderlyingPrice) > 1) {
    stop("Error: Input must have only 1 ticker, 1 quote date, and a consistent underlying price.")
  }

  # Calculate days to expiry and option ratio
  input_option_chain[, `:=`( 
    days_to_expiry = as.numeric(as.Date(ExpirationDate) - as.Date(DataDate)),
    business_days_to_expiry = as.numeric(bizdays(as.Date(DataDate), as.Date(ExpirationDate), "QuantLib/UnitedStates/NYSE")) 
    )]
  input_option_chain[, mean_days_to_expiry := rowMeans(.SD, na.rm = TRUE), .SDcols = c("days_to_expiry", "business_days_to_expiry")]
  input_option_chain[, option_ratio := StrikePrice / UnderlyingPrice]

  # Apply filters
  strike_filter <- (is.na(min_strike_ratio) | input_option_chain$option_ratio > min_strike_ratio) & 
    (is.na(max_strike_ratio) | input_option_chain$option_ratio <= max_strike_ratio)
  days_filter <- (is.na(min_avg_days_to_expiry) | input_option_chain$mean_days_to_expiry >= min_avg_days_to_expiry) & 
    (is.na(max_avg_days_to_expiry) | input_option_chain$mean_days_to_expiry < max_avg_days_to_expiry)
  filtered_option_chain <- input_option_chain[strike_filter & days_filter]

  # Construct results
  temp_results <- list(
    option_underlying_ticker = input_option_chain$Symbol[1],
    option_quote_date = input_option_chain$DataDate[1],
    option_underlying_price = input_option_chain$UnderlyingPrice[1]#,
    #option_strike_range = paste(min_strike_ratio, "to", max_strike_ratio),
    #option_expiry_range = paste(min_avg_days_to_expiry, "to", max_avg_days_to_expiry)
  )

  # Aggregate call and put data
  call_data <- filtered_option_chain[PutCall == "call"]
  put_data <- filtered_option_chain[PutCall == "put"]

  temp_results <- c(temp_results, list(
    option_total_call_listings = nrow(call_data),
    option_call_total_volume = sum(call_data$Volume, na.rm = TRUE),
    option_call_total_open_interest = sum(call_data$OpenInterest, na.rm = TRUE),
    option_total_put_listings = nrow(put_data),
    option_put_total_volume = sum(put_data$Volume, na.rm = TRUE),
    option_put_total_open_interest = sum(put_data$OpenInterest, na.rm = TRUE)
  ))

  return(as.data.frame(temp_results))
}

process_fileV3 <- function(file_paths) {
  # Efficient data reading using fread from data.table
  combined_data <- rbindlist(lapply(file_paths, fread))
  combined_data <- combined_data[as.Date(combined_data$ExpirationDate) < as.Date("2030-12-31"),]
  
  # Filter for the first 1000 unique tickers for demonstration
  all_tickers <- unique(combined_data$Symbol)#[1:100]

  # Calculate option_ratio
  combined_data[, option_ratio := StrikePrice / UnderlyingPrice]
  
  results_list <- lapply(all_tickers, function(ticker) {
    test_chain <- combined_data[Symbol == ticker]

    # Suggest starting with <10, 10-25, 25-50, 50-100, 100-200, 200-350, >350
    min_strike_set = c(NA, 0.5, 0.75, 0.9, 0.95, 1, 1.05, 1.1, 1.25, 1.5)
    max_strike_set = c(0.5, 0.75, 0.9, 0.95, 1, 1.05, 1.1, 1.25, 1.5, NA)
    min_day_set = c(NA, 5, 10, 20, 50, 100, 200, 350)
    max_day_set = c(5, 10, 20, 50, 100, 200, 350, NA)
    merge_chain = NULL
    for (temp_strike_i in 1:length(min_strike_set)) {
      for (temp_day_i in 1:length(min_day_set)) {
        # Aggregate over all strike ranges
        test_result = option_chain_aggregatorV3(
          test_chain,
          min_strike_ratio = min_strike_set[temp_strike_i],
          max_strike_ratio = max_strike_set[temp_strike_i],
          min_avg_days_to_expiry = min_day_set[temp_day_i],
          max_avg_days_to_expiry = max_day_set[temp_day_i]
        )
        colnames(test_result)[!(colnames(test_result) %in% c("option_underlying_ticker",
                                       "option_quote_date",
                                       "option_underlying_price"))] = 
          paste0(colnames(test_result)[!(colnames(test_result) %in% c("option_underlying_ticker",
                                       "option_quote_date",
                                       "option_underlying_price"))],
                                     "_strike_",min_strike_set[temp_strike_i],"to",max_strike_set[temp_strike_i],
                                     "_expiry_",min_day_set[temp_day_i],"to",max_day_set[temp_day_i])
        if(temp_strike_i == 1 & temp_day_i == 1){
          merge_chain = test_result
        }else{
          merge_chain = cbind(merge_chain,
                              test_result[,!(colnames(test_result) %in% c("option_underlying_ticker",
                                                                          "option_quote_date",
                                                                          "option_underlying_price"))])
        }
      }
    }
    return(merge_chain)
  })

  # Combine all ticker results
  new_chain <- rbindlist(results_list, use.names = TRUE, fill = TRUE)

  return(new_chain)
}

# Set main directory and read file names
main_dir <- "E:/Market_Data/DiscountOptionData/DTNSubscription/"
setwd(main_dir)

raw_files <- list.files(pattern = "OData1\\.csv$")
date_list <- sapply(raw_files, function(x) sub("_(OData1\\.csv)$", "", x))

existing_files <- list.files(paste0(main_dir,"revised_aggregate_files/"),pattern = "aggregate\\.RDS$")
existing_dates <- sapply(existing_files, function(x) sub("_(aggregate\\.RDS)$", "", x))

date_list <- date_list[!(date_list %in% existing_dates)]

# Prepare file paths for each date
file_paths <- lapply(date_list, function(date) {
  c(paste0(main_dir, date, "_OData1.csv"), paste0(main_dir, date, "_OData2.csv"))
})

# Parallel processing
num_cores <- detectCores()
batch_i <- 1
timestamp()
while(batch_i*12 < length(date_list)){
  sub_file_paths <- file_paths[(1+(12*(batch_i-1))):(12*(batch_i))]
  cl <- makeCluster(num_cores)
  clusterExport(cl, c("sub_file_paths", "option_chain_aggregatorV3", "process_fileV3"))
  clusterEvalQ(cl, {
    library(data.table)
    library(bizdays)
    library(stringr)
    load_quantlib_calendars("UnitedStates/NYSE",from="2000-01-01",to="2030-12-31")
    # Load any other libraries or source any scripts used in process_file or option_chain_aggregatorV2
  })

  # Execute in parallel and measure time
  results <- NULL
  system.time({
    results <- parLapply(cl, seq_along(sub_file_paths), function(i) {
      process_fileV3(sub_file_paths[[i]])
    })
  })
  stopCluster(cl)
  for(temp_i in 1:length(results)){
    temp_date <- results[[temp_i]]$option_quote_date[1]
    temp_date <- str_replace_all(temp_date,"-","")
    saveRDS(results[[temp_i]],file=paste0("revised_aggregate_files/D_",temp_date,"_aggregate.RDS"))
  }
  print(paste0("Finished batch ",batch_i))
  timestamp()
  batch_i <- batch_i + 1
}
sub_file_paths <- file_paths[(1+(12*(batch_i-1))):(length(file_paths))]
cl <- makeCluster(num_cores)
clusterExport(cl, c("sub_file_paths", "option_chain_aggregatorV3", "process_fileV3"))
clusterEvalQ(cl, {
  library(data.table)
  library(bizdays)
  library(stringr)
  load_quantlib_calendars("UnitedStates/NYSE",from="2000-01-01",to="2030-12-31")
  # Load any other libraries or source any scripts used in process_file or option_chain_aggregatorV2
})
# Execute in parallel and measure time
results <- NULL
system.time({
  results <- parLapply(cl, seq_along(sub_file_paths), function(i) {
    process_fileV3(sub_file_paths[[i]])
  })
})
stopCluster(cl)
for(temp_i in 1:length(results)){
  temp_date <- results[[temp_i]]$option_quote_date[1]
  temp_date <- str_replace_all(temp_date,"-","")
  saveRDS(results[[temp_i]],file=paste0("revised_aggregate_files/D_",temp_date,"_aggregate.RDS"))
}
print(paste0("Finished batch ",batch_i))
timestamp()

###Update aggregate preparation to use previous data to calculate new data




```

```{r prepare aggregate files}

library(dplyr)
library(stringr)

###Get list of aggregate files
main_dir <- "E:/Market_Data/DiscountOptionData/DTNSubscription/"
aggregate_files <- list.files(paste0(main_dir,"revised_aggregate_files/"), pattern = "aggregate\\.RDS$")
##Start with earliest aggregate file
aggregate_files <- aggregate_files[order(aggregate_files)]
aggregate_dates <- lapply(aggregate_files, function(x) { as.Date(str_split(x, "_")[[1]][2], format = "%Y%m%d") })
aggregate_dates <- as.Date(unlist(aggregate_dates))  # Explicitly convert back to Date after unlisting

###Load each day and add any new tickers to the current list
test_files <- list.files(paste0(main_dir,"revised_derived_aggregates/"))
test_option_files <- test_files[grepl("full_option_aggregate_",test_files)]
all_dates <- NULL
added_dates <- NULL
if(length(test_option_files) > 0){
  temp_dates <- unlist(lapply(test_option_files,function(x){str_replace(str_replace(x,".RDS",""),"full_option_aggregate_","")}))
  #start_dates <- as.Date(unlist(lapply(temp_dates,function(x){str_split(x,"_to_")[[1]][1]})), format = "%Y-%m-%d")
  #start_dates <- start_dates[order(start_dates,decreasing = TRUE)]
  end_dates <- as.Date(unlist(lapply(temp_dates,function(x){str_split(x,"_to_")[[1]][2]})), format = "%Y-%m-%d")
  end_dates <- end_dates[order(end_dates,decreasing = TRUE)]
  last_date <- end_dates[1]
  start_dates <- as.Date(unlist(lapply(temp_dates,function(x){str_split(x,"_to_")[[1]][1]})), format = "%Y-%m-%d")
  start_dates <- start_dates[order(start_dates,decreasing = TRUE)]
  save_start_date <- start_dates[1]
  aggregate_files <- aggregate_files[aggregate_dates > last_date]
  
  full_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("full_option_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  all_dates <- unique(full_aggregate$option_quote_date)
  all_dates <- all_dates[order(all_dates)]
  EMA5_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("EMA5_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  EMA10_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("EMA10_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  EMA20_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("EMA20_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  EMA50_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("EMA50_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  SMA5_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("SMA5_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  SMA10_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("SMA10_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  SMA20_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("SMA20_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  SMA50_df <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                   test_files[grepl("SMA50_aggregate_",test_files) & grepl(end_dates[1],test_files)]))
  if(length(all_dates) < 50){
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("full_option_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    sub_dates <- unique(temp_aggregate$option_quote_date)
    sub_dates <- sub_dates[order(sub_dates)]
    temp_start_date <- sub_dates[(length(sub_dates)-49)]
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    full_aggregate <- rbind(temp_aggregate,full_aggregate)
    all_dates <- unique(full_aggregate$option_quote_date)
    all_dates <- all_dates[order(all_dates)]
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("EMA5_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    EMA5_df <- rbind(temp_aggregate,EMA5_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("EMA10_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    EMA10_df <- rbind(temp_aggregate,EMA10_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("EMA20_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    EMA20_df <- rbind(temp_aggregate,EMA20_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("EMA50_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    EMA50_df <- rbind(temp_aggregate,EMA50_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("SMA5_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    SMA5_df <- rbind(temp_aggregate,SMA5_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("SMA10_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    SMA10_df <- rbind(temp_aggregate,SMA10_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("SMA20_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    SMA20_df <- rbind(temp_aggregate,SMA20_df)
    
    temp_aggregate <- readRDS(paste0(main_dir,"revised_derived_aggregates/",
                                     test_files[grepl("SMA50_aggregate_",test_files) & grepl(end_dates[2],test_files)]))
    temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= temp_start_date,]
    SMA50_df <- rbind(temp_aggregate,SMA50_df)
  }
}else{
  full_aggregate <- NULL
  EMA5_df <- NULL
  EMA10_df <- NULL
  EMA20_df <- NULL
  EMA50_df <- NULL
  SMA5_df <- NULL
  SMA10_df <- NULL
  SMA20_df <- NULL
  SMA50_df <- NULL
  last_date <- NULL
}
if(length(aggregate_files) > 0){
  for(temp_file_i in 1:length(aggregate_files)){
    temp_file <- readRDS(paste0(main_dir,"revised_aggregate_files/",aggregate_files[temp_file_i]))
    new_date <- unique(temp_file$option_quote_date)
    if(is.null(save_start_date)){
      save_start_date <- new_date
    }
    if(length(new_date) > 1){
      print(paste0("Error with dates in ",aggregate_files[temp_file_i]))
      break
    }else{
      if(is.null(all_dates)){
        all_dates <- new_date
      }else{
        all_dates <- c(all_dates,new_date)
      }
      if(is.null(added_dates)){
        added_dates <- new_date
      }else{
        added_dates <- c(added_dates,new_date)
      }
      ##Create full aggregate with volume and open interest and derived values
      if(is.null(full_aggregate)){
        full_aggregate <- temp_file
      }else{
        full_aggregate <- as.data.frame(rbind(full_aggregate,temp_file))
      }
      if(!is.null(EMA5_df)){
        temp_EMA5_tickers <- EMA5_df$option_underlying_ticker[EMA5_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(SMA5_df)){
        temp_SMA5_tickers <- SMA5_df$option_underlying_ticker[SMA5_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(EMA10_df)){
        temp_EMA10_tickers <- EMA10_df$option_underlying_ticker[EMA10_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(SMA10_df)){
        temp_SMA10_tickers <- SMA10_df$option_underlying_ticker[SMA10_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(EMA20_df)){
        temp_EMA20_tickers <- EMA20_df$option_underlying_ticker[EMA20_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(SMA20_df)){
        temp_SMA20_tickers <- SMA20_df$option_underlying_ticker[SMA20_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(EMA50_df)){
        temp_EMA50_tickers <- EMA50_df$option_underlying_ticker[EMA50_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      if(!is.null(SMA50_df)){
        temp_SMA50_tickers <- SMA50_df$option_underlying_ticker[SMA50_df$option_quote_date == all_dates[(length(all_dates)-1)]]
      }
      
      ##Calculate new EMA5 for all new stocks with prior EMA5
      sub_aggregate <- full_aggregate[full_aggregate$option_quote_date == new_date,]
      sub_tickers <- unique(sub_aggregate$option_underlying_ticker)
      if(!is.null(EMA5_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_EMA5_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema5_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_ema5_df <- EMA5_df[EMA5_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_ema5_df <- temp_ema5_df[temp_ema5_df$option_underlying_ticker %in% temp_tickers,]
        temp_ema5_df <- temp_ema5_df[order(temp_ema5_df$option_underlying_ticker),]
        temp_ema5_df <- temp_ema5_df[,!(colnames(temp_ema5_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_ema5_df)){
          temp_ema5 <- (temp_aggregate) * (2/6) + (temp_ema5_df) * (1 - (2/6))
          temp_ema5 <- as.data.frame(cbind(temp_ema5_cols,round(temp_ema5,2)))
          EMA5_df <- as.data.frame(rbind(EMA5_df,temp_ema5))
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_EMA5_tickers)]
          print(paste0("EMA5 calculated from prior EMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with EMA5 calculation for ", new_date))
        )
      }
      if(!is.null(SMA5_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_SMA5_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema5_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_sma5_df <- SMA5_df[SMA5_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_sma5_df <- temp_sma5_df[temp_sma5_df$option_underlying_ticker %in% temp_tickers,]
        temp_sma5_df <- temp_sma5_df[order(temp_sma5_df$option_underlying_ticker),]
        temp_sma5_df <- temp_sma5_df[,!(colnames(temp_sma5_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_sma5_df)){
          temp_ema5 <- (temp_aggregate) * (2/6) + (temp_sma5_df) * (1 - (2/6))
          temp_ema5 <- as.data.frame(cbind(temp_ema5_cols,round(temp_ema5,2)))
          if(!is.null(EMA5_df)){
            EMA5_df <- as.data.frame(rbind(EMA5_df,temp_ema5))
          }else{
            EMA5_df <- as.data.frame(temp_ema5)
          }
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_SMA5_tickers)]
          print(paste0("EMA5 calculated from prior SMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with SMA5 calculation for ", new_date))
        )
      }
      if(length(all_dates) >= 5){
        check_dates <- all_dates[(length(all_dates)-4):length(all_dates)]
        sub_aggregate <- full_aggregate[full_aggregate$option_quote_date %in% check_dates,]
        sub_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% sub_tickers,]
        sub_aggregate <- sub_aggregate[order(sub_aggregate$option_underlying_ticker),]
        temp_tickers <- sub_tickers[sub_tickers %in% sub_aggregate$option_underlying_ticker]
        failed_tickers <- c()
        if(length(temp_tickers) > 0){
          if(length(temp_tickers) > 1000){
            print(paste0("Expect long run time for this date due to high number of SMA5 calculations"))
            timestamp()
          }
          for(temp_ticker_i in 1:length(temp_tickers)){
            temp_ticker <- temp_tickers[temp_ticker_i]
            temp_sma5_df <- data.frame(option_underlying_ticker=temp_ticker,option_quote_date=new_date)
            temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker == temp_ticker,]
            temp_aggregate <- temp_aggregate[,!(colnames(sub_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
            if(nrow(temp_aggregate) == 5){
              temp_sma5_df <- as.data.frame(cbind(temp_sma5_df,t(round(colMeans(temp_aggregate),4))))
              if(!is.null(SMA5_df)){
                SMA5_df <- as.data.frame(rbind(SMA5_df,temp_sma5_df))
              }else{
                SMA5_df <- as.data.frame(temp_sma5_df)
              }
              if(temp_ticker_i %% 1000 == 0){
                timestamp()
                print(paste0("SMA5 calculated for ",temp_ticker_i," tickers"))
              }
            }else{
              failed_tickers <- c(failed_tickers,temp_ticker)
            }
          }
        }
        sub_tickers <- sub_tickers[!(sub_tickers %in% temp_tickers)]
        print(paste0("SMA5 calculated for ",length(temp_tickers)," tickers"))
        failed_tickers <- c(sub_tickers,failed_tickers)
        print(paste0("Insufficient SMA5 data for ",length(failed_tickers)," tickers"))
      }else{
        print(paste0("Insufficient EMA5 or SMA5 data for ",length(sub_tickers)," tickers"))
      }
      
      sub_aggregate <- full_aggregate[full_aggregate$option_quote_date == new_date,]
      sub_tickers <- unique(sub_aggregate$option_underlying_ticker)
      if(!is.null(EMA10_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_EMA10_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema10_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_ema10_df <- EMA10_df[EMA10_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_ema10_df <- temp_ema10_df[temp_ema10_df$option_underlying_ticker %in% temp_tickers,]
        temp_ema10_df <- temp_ema10_df[order(temp_ema10_df$option_underlying_ticker),]
        temp_ema10_df <- temp_ema10_df[,!(colnames(temp_ema10_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_ema10_df)){
          temp_ema10 <- (temp_aggregate) * (2/11) + (temp_ema10_df) * (1 - (2/11))
          temp_ema10 <- as.data.frame(cbind(temp_ema10_cols,round(temp_ema10,2)))
          EMA10_df <- as.data.frame(rbind(EMA10_df,temp_ema10))
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_EMA10_tickers)]
          print(paste0("EMA10 calculated from prior EMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with EMA10 calculation for ", new_date))
        )
      }
      if(!is.null(SMA10_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_SMA10_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema10_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_sma10_df <- SMA10_df[SMA10_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_sma10_df <- temp_sma10_df[temp_sma10_df$option_underlying_ticker %in% temp_tickers,]
        temp_sma10_df <- temp_sma10_df[order(temp_sma10_df$option_underlying_ticker),]
        temp_sma10_df <- temp_sma10_df[,!(colnames(temp_sma10_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_sma10_df)){
          temp_ema10 <- (temp_aggregate) * (2/11) + (temp_sma10_df) * (1 - (2/11))
          temp_ema10 <- as.data.frame(cbind(temp_ema10_cols,round(temp_ema10,2)))
          if(!is.null(EMA10_df)){
            EMA10_df <- as.data.frame(rbind(EMA10_df,temp_ema10))
          }else{
            EMA10_df <- as.data.frame(temp_ema10)
          }
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_SMA10_tickers)]
          print(paste0("EMA10 calculated from prior SMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with SMA10 calculation for ", new_date))
        )
      }
      if(length(all_dates) >= 10){
        check_dates <- all_dates[(length(all_dates)-9):length(all_dates)]
        sub_aggregate <- full_aggregate[full_aggregate$option_quote_date %in% check_dates,]
        sub_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% sub_tickers,]
        sub_aggregate <- sub_aggregate[order(sub_aggregate$option_underlying_ticker),]
        temp_tickers <- sub_tickers[sub_tickers %in% sub_aggregate$option_underlying_ticker]
        failed_tickers <- c()
        if(length(temp_tickers) > 0){
          if(length(temp_tickers) > 1000){
            print(paste0("Expect long run time for this date due to high number of SMA10 calculations"))
            timestamp()
          }
          for(temp_ticker_i in 1:length(temp_tickers)){
            temp_ticker <- temp_tickers[temp_ticker_i]
            temp_sma10_df <- data.frame(option_underlying_ticker=temp_ticker,option_quote_date=new_date)
            temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker == temp_ticker,]
            temp_aggregate <- temp_aggregate[,!(colnames(sub_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
            if(nrow(temp_aggregate) == 10){
              temp_sma10_df <- as.data.frame(cbind(temp_sma10_df,t(round(colMeans(temp_aggregate),4))))
              if(!is.null(SMA10_df)){
                SMA10_df <- as.data.frame(rbind(SMA10_df,temp_sma10_df))
              }else{
                SMA10_df <- as.data.frame(temp_sma10_df)
              }
              if(temp_ticker_i %% 1000 == 0){
                timestamp()
                print(paste0("SMA10 calculated for ",temp_ticker_i," tickers"))
              }
            }else{
              failed_tickers <- c(failed_tickers,temp_ticker)
            }
          }
        }
        sub_tickers <- sub_tickers[!(sub_tickers %in% temp_tickers)]
        print(paste0("SMA10 calculated for ",length(temp_tickers)," tickers"))
        failed_tickers <- c(sub_tickers,failed_tickers)
        print(paste0("Insufficient SMA10 data for ",length(failed_tickers)," tickers"))
      }else{
        print(paste0("Insufficient EMA10 or SMA10 data for ",length(sub_tickers)," tickers"))
      }
      
      sub_aggregate <- full_aggregate[full_aggregate$option_quote_date == new_date,]
      sub_tickers <- unique(sub_aggregate$option_underlying_ticker)
      if(!is.null(EMA20_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_EMA20_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema20_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_ema20_df <- EMA20_df[EMA20_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_ema20_df <- temp_ema20_df[temp_ema20_df$option_underlying_ticker %in% temp_tickers,]
        temp_ema20_df <- temp_ema20_df[order(temp_ema20_df$option_underlying_ticker),]
        temp_ema20_df <- temp_ema20_df[,!(colnames(temp_ema20_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_ema20_df)){
          temp_ema20 <- (temp_aggregate) * (2/21) + (temp_ema20_df) * (1 - (2/21))
          temp_ema20 <- as.data.frame(cbind(temp_ema20_cols,round(temp_ema20,2)))
          EMA20_df <- as.data.frame(rbind(EMA20_df,temp_ema20))
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_EMA20_tickers)]
          print(paste0("EMA20 calculated from prior EMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with EMA20 calculation for ", new_date))
        )
      }
      if(!is.null(SMA20_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_SMA20_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema20_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_sma20_df <- SMA20_df[SMA20_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_sma20_df <- temp_sma20_df[temp_sma20_df$option_underlying_ticker %in% temp_tickers,]
        temp_sma20_df <- temp_sma20_df[order(temp_sma20_df$option_underlying_ticker),]
        temp_sma20_df <- temp_sma20_df[,!(colnames(temp_sma20_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_sma20_df)){
          temp_ema20 <- (temp_aggregate) * (2/21) + (temp_sma20_df) * (1 - (2/21))
          temp_ema20 <- as.data.frame(cbind(temp_ema20_cols,round(temp_ema20,2)))
          if(!is.null(EMA20_df)){
            EMA20_df <- as.data.frame(rbind(EMA20_df,temp_ema20))
          }else{
            EMA20_df <- as.data.frame(temp_ema20)
          }
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_SMA20_tickers)]
          print(paste0("EMA20 calculated from prior SMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with SMA20 calculation for ", new_date))
        )
      }
      if(length(all_dates) >= 20){
        check_dates <- all_dates[(length(all_dates)-19):length(all_dates)]
        sub_aggregate <- full_aggregate[full_aggregate$option_quote_date %in% check_dates,]
        sub_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% sub_tickers,]
        sub_aggregate <- sub_aggregate[order(sub_aggregate$option_underlying_ticker),]
        temp_tickers <- sub_tickers[sub_tickers %in% sub_aggregate$option_underlying_ticker]
        failed_tickers <- c()
        if(length(temp_tickers) > 0){
          if(length(temp_tickers) > 1000){
            print(paste0("Expect long run time for this date due to high number of SMA20 calculations"))
            timestamp()
          }
          for(temp_ticker_i in 1:length(temp_tickers)){
            temp_ticker <- temp_tickers[temp_ticker_i]
            temp_sma20_df <- data.frame(option_underlying_ticker=temp_ticker,option_quote_date=new_date)
            temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker == temp_ticker,]
            temp_aggregate <- temp_aggregate[,!(colnames(sub_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
            if(nrow(temp_aggregate) == 20){
              temp_sma20_df <- as.data.frame(cbind(temp_sma20_df,t(round(colMeans(temp_aggregate),4))))
              if(!is.null(SMA20_df)){
                SMA20_df <- as.data.frame(rbind(SMA20_df,temp_sma20_df))
              }else{
                SMA20_df <- as.data.frame(temp_sma20_df)
              }
              if(temp_ticker_i %% 1000 == 0){
                timestamp()
                print(paste0("SMA20 calculated for ",temp_ticker_i," tickers"))
              }
            }else{
              failed_tickers <- c(failed_tickers,temp_ticker)
            }
          }
        }
        sub_tickers <- sub_tickers[!(sub_tickers %in% temp_tickers)]
        print(paste0("SMA20 calculated for ",length(temp_tickers)," tickers"))
        failed_tickers <- c(sub_tickers,failed_tickers)
        print(paste0("Insufficient SMA20 data for ",length(failed_tickers)," tickers"))
      }else{
        print(paste0("Insufficient EMA20 or SMA20 data for ",length(sub_tickers)," tickers"))
      }
      
      sub_aggregate <- full_aggregate[full_aggregate$option_quote_date == new_date,]
      sub_tickers <- unique(sub_aggregate$option_underlying_ticker)
      if(!is.null(EMA50_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_EMA50_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema50_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_ema50_df <- EMA50_df[EMA50_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_ema50_df <- temp_ema50_df[temp_ema50_df$option_underlying_ticker %in% temp_tickers,]
        temp_ema50_df <- temp_ema50_df[order(temp_ema50_df$option_underlying_ticker),]
        temp_ema50_df <- temp_ema50_df[,!(colnames(temp_ema50_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_ema50_df)){
          temp_ema50 <- (temp_aggregate) * (2/51) + (temp_ema50_df) * (1 - (2/51))
          temp_ema50 <- as.data.frame(cbind(temp_ema50_cols,round(temp_ema50,2)))
          EMA50_df <- as.data.frame(rbind(EMA50_df,temp_ema50))
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_EMA50_tickers)]
          print(paste0("EMA50 calculated from prior EMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with EMA50 calculation for ", new_date))
        )
      }
      if(!is.null(SMA50_df)){
        temp_tickers <- sub_tickers[sub_tickers %in% temp_SMA50_tickers]
        temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% temp_tickers,]
        temp_aggregate <- temp_aggregate[order(temp_aggregate$option_underlying_ticker),]
        temp_ema50_cols <- temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
        temp_aggregate <- temp_aggregate[,!(colnames(temp_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
        temp_sma50_df <- SMA50_df[SMA50_df$option_quote_date == all_dates[(length(all_dates)-1)],]
        temp_sma50_df <- temp_sma50_df[temp_sma50_df$option_underlying_ticker %in% temp_tickers,]
        temp_sma50_df <- temp_sma50_df[order(temp_sma50_df$option_underlying_ticker),]
        temp_sma50_df <- temp_sma50_df[,!(colnames(temp_sma50_df) %in% c("option_underlying_ticker","option_quote_date"))]
        if(nrow(temp_aggregate) == nrow(temp_sma50_df)){
          temp_ema50 <- (temp_aggregate) * (2/51) + (temp_sma50_df) * (1 - (2/51))
          temp_ema50 <- as.data.frame(cbind(temp_ema50_cols,round(temp_ema50,2)))
          if(!is.null(EMA50_df)){
            EMA50_df <- as.data.frame(rbind(EMA50_df,temp_ema50))
          }else{
            EMA50_df <- as.data.frame(temp_ema50)
          }
          sub_tickers <- sub_tickers[!(sub_tickers %in% temp_SMA50_tickers)]
          print(paste0("EMA50 calculated from prior SMA for ",length(temp_tickers)," tickers"))
        }else(
          print(paste0("Error with SMA50 calculation for ", new_date))
        )
      }
      if(length(all_dates) >= 50){
        check_dates <- all_dates[(length(all_dates)-49):length(all_dates)]
        sub_aggregate <- full_aggregate[full_aggregate$option_quote_date %in% check_dates,]
        sub_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker %in% sub_tickers,]
        sub_aggregate <- sub_aggregate[order(sub_aggregate$option_underlying_ticker),]
        temp_tickers <- sub_tickers[sub_tickers %in% sub_aggregate$option_underlying_ticker]
        failed_tickers <- c()
        if(length(temp_tickers) > 0){
          if(length(temp_tickers) > 1000){
            print(paste0("Expect long run time for this date due to high number of SMA50 calculations"))
            timestamp()
          }
          for(temp_ticker_i in 1:length(temp_tickers)){
            temp_ticker <- temp_tickers[temp_ticker_i]
            temp_sma50_df <- data.frame(option_underlying_ticker=temp_ticker,option_quote_date=new_date)
            temp_aggregate <- sub_aggregate[sub_aggregate$option_underlying_ticker == temp_ticker,]
            temp_aggregate <- temp_aggregate[,!(colnames(sub_aggregate) %in% c("option_underlying_ticker","option_quote_date"))]
            if(nrow(temp_aggregate) == 50){
              temp_sma50_df <- as.data.frame(cbind(temp_sma50_df,t(round(colMeans(temp_aggregate),4))))
              if(!is.null(SMA50_df)){
                SMA50_df <- as.data.frame(rbind(SMA50_df,temp_sma50_df))
              }else{
                SMA50_df <- as.data.frame(temp_sma50_df)
              }
              if(temp_ticker_i %% 1000 == 0){
                timestamp()
                print(paste0("SMA50 calculated for ",temp_ticker_i," tickers"))
              }
            }else{
              failed_tickers <- c(failed_tickers,temp_ticker)
            }
          }
        }
        sub_tickers <- sub_tickers[!(sub_tickers %in% temp_tickers)]
        print(paste0("SMA50 calculated for ",length(temp_tickers)," tickers"))
        failed_tickers <- c(sub_tickers,failed_tickers)
        print(paste0("Insufficient SMA50 data for ",length(failed_tickers)," tickers"))
      }else{
        print(paste0("Insufficient EMA50 or SMA50 data for ",length(sub_tickers)," tickers"))
      }
      print(paste0("Finished EMA calculations for ",new_date))
      
      ##Save data and reset objects while retaining values for continued EMA and SMA calculation
      if(!is.null(save_start_date)){
        test_dates <- all_dates[all_dates >= save_start_date]
      }else{
        test_dates <- all_dates
      }
      while(length(test_dates) > 100){
        save_start_date <- test_dates[101]
        test_dates <- all_dates[all_dates >= save_start_date]
      }
      #if(length(test_dates) %% 100 == 0){
      if(length(test_dates) == 100){
        #if(is.null(last_date)){
        #  temp_start_date <- min(added_dates)
        #}else{
        #  temp_start_date <- min(added_dates[added_dates > last_date])
        #}
        temp_start_date <- save_start_date
        temp_end_date <- max(all_dates)
        temp_base_path <- "E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/"
        saveRDS(full_aggregate[full_aggregate$option_quote_date >= temp_start_date &
                                          full_aggregate$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"full_option_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(SMA5_df[SMA5_df$option_quote_date >= temp_start_date &
                                          SMA5_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"SMA5_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(SMA10_df[SMA10_df$option_quote_date >= temp_start_date &
                                          SMA10_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"SMA10_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(SMA20_df[SMA20_df$option_quote_date >= temp_start_date &
                                          SMA20_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"SMA20_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(SMA50_df[SMA50_df$option_quote_date >= temp_start_date &
                                          SMA50_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"SMA50_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(EMA5_df[EMA5_df$option_quote_date >= temp_start_date &
                                          EMA5_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"EMA5_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(EMA10_df[EMA10_df$option_quote_date >= temp_start_date &
                                          EMA10_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"EMA10_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(EMA20_df[EMA20_df$option_quote_date >= temp_start_date &
                                          EMA20_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"EMA20_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        saveRDS(EMA50_df[EMA50_df$option_quote_date >= temp_start_date &
                                          EMA50_df$option_quote_date <= temp_end_date,],
                file=paste0(temp_base_path,"EMA50_aggregate_",
                            temp_start_date,"_to_",temp_end_date,".RDS"))
        save_start_date <- NULL
        dates_to_keep <- added_dates[(length(added_dates)-49):length(added_dates)]
        new_start_date <- min(dates_to_keep)
        new_end_date <- max(dates_to_keep)
        last_date <- new_end_date
        ##Update objects after save with dates to keep
        full_aggregate <- full_aggregate[full_aggregate$option_quote_date >= new_start_date &
                                          full_aggregate$option_quote_date <= new_end_date,]
        SMA5_df <- SMA5_df[SMA5_df$option_quote_date >= new_start_date &
                                          SMA5_df$option_quote_date <= new_end_date,]
        SMA10_df <- SMA10_df[SMA10_df$option_quote_date >= new_start_date &
                                          SMA10_df$option_quote_date <= new_end_date,]
        SMA20_df <- SMA20_df[SMA20_df$option_quote_date >= new_start_date &
                                          SMA20_df$option_quote_date <= new_end_date,]
        SMA50_df <- SMA50_df[SMA50_df$option_quote_date >= new_start_date &
                                          SMA50_df$option_quote_date <= new_end_date,]
        EMA5_df <- EMA5_df[EMA5_df$option_quote_date >= new_start_date &
                                          EMA5_df$option_quote_date <= new_end_date,]
        EMA10_df <- EMA10_df[EMA10_df$option_quote_date >= new_start_date &
                                          EMA10_df$option_quote_date <= new_end_date,]
        EMA20_df <- EMA20_df[EMA20_df$option_quote_date >= new_start_date &
                                          EMA20_df$option_quote_date <= new_end_date,]
        EMA50_df <- EMA50_df[EMA50_df$option_quote_date >= new_start_date &
                                          EMA50_df$option_quote_date <= new_end_date,]
      }
    }
  }
  if(length(test_dates) != 100){
    temp_start_date <- save_start_date
    temp_end_date <- max(added_dates)
    temp_base_path <- "E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/"
    saveRDS(full_aggregate[full_aggregate$option_quote_date >= temp_start_date &
                                      full_aggregate$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"full_option_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(SMA5_df[SMA5_df$option_quote_date >= temp_start_date &
                                      SMA5_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"SMA5_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(SMA10_df[SMA10_df$option_quote_date >= temp_start_date &
                                      SMA10_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"SMA10_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(SMA20_df[SMA20_df$option_quote_date >= temp_start_date &
                                      SMA20_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"SMA20_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(SMA50_df[SMA50_df$option_quote_date >= temp_start_date &
                                      SMA50_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"SMA50_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(EMA5_df[EMA5_df$option_quote_date >= temp_start_date &
                                      EMA5_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"EMA5_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(EMA10_df[EMA10_df$option_quote_date >= temp_start_date &
                                      EMA10_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"EMA10_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(EMA20_df[EMA20_df$option_quote_date >= temp_start_date &
                                      EMA20_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"EMA20_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
    saveRDS(EMA50_df[EMA50_df$option_quote_date >= temp_start_date &
                                      EMA50_df$option_quote_date <= temp_end_date,],
            file=paste0(temp_base_path,"EMA50_aggregate_",
                        temp_start_date,"_to_",temp_end_date,".RDS"))
  }
}

###Check for prior SMA if no EMA value is present and calculate new EMA if present

###Check for required number of days to calculate SMA and calculate if present

```

```{r create new output dataset for NN modeling}

library(stringr)

##Create outcome tables
stock_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2024-01-22_to_2024-04-04.RDS")
stock_aggregate <- stock_aggregate[,1:3]
stock_aggregate <- stock_aggregate[stock_aggregate$option_quote_date >= "2024-01-22" & stock_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[,1:3]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
stock_aggregate <- as.data.frame(rbind(temp_aggregate,stock_aggregate))
stock_aggregate <- stock_aggregate[order(stock_aggregate$option_underlying_ticker,stock_aggregate$option_quote_date),]
all_tickers <- unique(stock_aggregate$option_underlying_ticker)
all_dates <- unique(stock_aggregate$option_quote_date)
filtered_tickers <- all_tickers

full_outcomes <- NULL
input_aggregate <- stock_aggregate[stock_aggregate$option_underlying_ticker %in% filtered_tickers,]
file_counter_i <- 1
for(temp_date_i in 1:length(all_dates)){
    temp_aggregate <- input_aggregate[input_aggregate$option_quote_date == all_dates[temp_date_i],]
    rownames(temp_aggregate) <- temp_aggregate$option_underlying_ticker
    temp_result = temp_aggregate[,c("option_underlying_ticker","option_quote_date")]
    for(temp_counter_i in 1:15){
        if((temp_date_i+temp_counter_i) < length(all_dates)){
            comp_aggregate = input_aggregate[input_aggregate$option_quote_date == all_dates[temp_date_i+temp_counter_i],]
            rownames(comp_aggregate) = comp_aggregate$option_underlying_ticker
            temp_result[,paste0("time",temp_counter_i,"_increase2")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.02*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase025")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.025*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase3")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.03*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase035")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.035*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase4")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.04*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase045")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.045*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase5")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.05*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase7")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.07*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase075")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.075*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase8")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.08*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase9")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.09*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase10")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.1*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase20")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.2*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_increase50")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] >= 1.5*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease2")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.98*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease025")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.975*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease5")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.95*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease075")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.925*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease10")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.9*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease20")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.8*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_decrease50")] = as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] <= 0.5*temp_aggregate$option_underlying_price)
            temp_result[,paste0("time",temp_counter_i,"_total_change")] = round(as.numeric(comp_aggregate[rownames(temp_aggregate),"option_underlying_price"] / temp_aggregate$option_underlying_price),5)
        }else{
            temp_result[,paste0("time",temp_counter_i,"_increase2")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase025")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase3")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase035")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase4")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase045")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase5")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase7")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase075")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase8")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase9")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase10")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase20")] = NA
            temp_result[,paste0("time",temp_counter_i,"_increase50")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease2")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease025")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease5")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease075")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease10")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease20")] = NA
            temp_result[,paste0("time",temp_counter_i,"_decrease50")] = NA
            temp_result[,paste0("time",temp_counter_i,"_total_change")] = NA
        }
    }
    #rownames(temp_result) <- paste0(temp_result$option_underlying_ticker,"_",
    #                                unlist(lapply(temp_result$option_quote_date,function(x){
    #                                  str_replace_all(x,"-","")
    #                                 })))
    if(is.null(full_outcomes)){
        full_outcomes = temp_result
    }else{
        full_outcomes = rbind(full_outcomes,temp_result)
    }
    print(paste0("Finished with day ",temp_date_i))
    if(temp_date_i %% 100 == 0){
      saveRDS(full_outcomes,file=paste0("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_outcomes_20210514_to_20240404_part",file_counter_i,".RDS"))
      full_outcomes <- NULL
      file_counter_i <- file_counter_i + 1
    }
}
if(temp_date_i %% 100 != 0){
  saveRDS(full_outcomes,file=paste0("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_outcomes_20210514_to_20240404_part",file_counter_i,".RDS"))
}

base_dir <- "E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/"
all_files <- list.files(base_dir)
all_files <- all_files[grepl("full_outcomes_20210514_to_20240404_part",all_files)]
full_outcomes <- NULL
for(temp_file_i in 1:length(all_files)){
  if(is.null(full_outcomes)){
    full_outcomes <- readRDS(paste0(base_dir,all_files[temp_file_i]))
  }else{
    temp_outcomes <- readRDS(paste0(base_dir,all_files[temp_file_i]))
    full_outcomes <- rbind(full_outcomes,temp_outcomes)
  }
}

saveRDS(full_outcomes,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_outcomesV2_20210514_to_20240404.RDS")

####


```

```{r create SP500 subset of tickers}

SP500_df <- read.table("E:/Market_Data/SP500_companies_alt_20240304.tsv",sep="\t",header=TRUE)
SP500_tickers <- unique(SP500_df$Symbol)
SP500_extras <- t(read.table("E:/Market_Data/SP500_extras_20210514_to_20240404.tsv",sep="\t",header=FALSE))
SP500_extras <- SP500_extras[!(SP500_extras %in% SP500_tickers)]
SP500_tickers <- c(SP500_tickers,SP500_extras)

temp_data <- read.csv("E:/Market_Data/nasdaq_screener_20240408.csv")
temp_data <- temp_data[!is.na(temp_data$Symbol),]
temp_data$Symbol <- unlist(lapply(temp_data$Symbol,function(x){str_replace_all(x,"/",".")}))
rownames(temp_data) <- temp_data$Symbol
SP500_tickers <- SP500_tickers[SP500_tickers %in% temp_data$Symbol]
saveRDS(SP500_tickers,"E:/Market_Data/SP500_tickers_20240404.RDS")

temp_data <- temp_data[SP500_tickers,c(1,10,11)]
temp_data[temp_data$Sector %in% c("","Miscellaneous"),]
temp_data["BRK.B","Sector"] <- "Finance"
temp_data["D","Sector"] <- "Utilities"
temp_data["ANSS","Sector"] <- "Technology"
temp_data["WRK","Sector"] <- "Consumer Discretionary"
temp_data["BF.B","Sector"] <- "Consumer Staples"
temp_data["BBWI","Sector"] <- "Consumer Discretionary"
temp_data["GEV","Sector"] <- "Utilities"
temp_data[temp_data$Sector %in% c("","Miscellaneous"),]
saveRDS(temp_data,"E:/Market_Data/SP500_sectors_20240404.RDS")

```

```{r get all stock splits}

library(quantmod)

SP500_tickers <- readRDS("E:/Market_Data/SP500_tickers_20240404.RDS")
SP500_tickers <- unlist(lapply(SP500_tickers,function(x){str_replace_all(x,"[.]","-")}))

stocks_to_drop = c()
#stocks_to_drop = c("ADS","AGN","AKS","ALXN","APC","AVP",
#                   "BBBY",,"CELG","CERN","COG","CTXS","CXO",
#                   "DF","DISCK","DLPH","DNR","DRE","DTV","ENDP","ESV","ETFC",
#                   "FB","FBHS","FII","FLIR","FRC","FRX","FTR","GRA","HFC","HRS",
#                   "JCP","JEC","KSU","LLL","LM","LSI","MON","MXIM",
#                   "NBL","NLSN","NYX","PBCT","QEP","RDC","RE","RHT","RRD","RTN",
#                   "SIVB","STI","TIF","TSS","VAR","VIAB","WCG","WIN","WPX","XEC","XL","XLNX","YHOO")
all_splits = NULL
for(temp_ticker_i in 1:length(SP500_tickers)){
  temp_ticker = SP500_tickers[temp_ticker_i]
  if(!(temp_ticker %in% stocks_to_drop)){
    splits <- getSplits(temp_ticker,from="2021-05-10",to="2024-04-09")
    temp_splits = as.data.frame(list(ticker=c(rep(temp_ticker,length(index(splits)))),date=c(index(splits))))
    if(is.null(all_splits)){
      all_splits = temp_splits
    }else{
      all_splits = rbind(all_splits,temp_splits)
    }
  }
  if(temp_ticker_i %% 50 == 0){
    print(paste0("Finished with ",temp_ticker_i," tickers"))
  }
}

saveRDS(all_splits,"E:/Market_Data/SP500_splits_20240409.RDS")

```

```{r derived interest rate EMAs}

all_rates <- read.csv("E:/Market_Data/DFF_20190405_to_20240405.csv")
all_rates <- all_rates[all_rates$DATE > "2021-01-01",]
all_rates <- all_rates[order(all_rates$DATE),]
rownames(all_rates) <- all_rates$DATE
all_dates <- all_rates$DATE
all_SMA5 <- c(rep(NA,length(all_dates)))
all_SMA10 <- c(rep(NA,length(all_dates)))
all_SMA20 <- c(rep(NA,length(all_dates)))
all_SMA50 <- c(rep(NA,length(all_dates)))
all_EMA5 <- c(rep(NA,length(all_dates)))
all_EMA10 <- c(rep(NA,length(all_dates)))
all_EMA20 <- c(rep(NA,length(all_dates)))
all_EMA50 <- c(rep(NA,length(all_dates)))
for(temp_date_i in 1:length(all_dates)){
  if(temp_date_i > 4){
    if(!is.na(all_EMA5[temp_date_i-1])){
      all_EMA5[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/6) + all_EMA5[temp_date_i-1] * (1 - (2/6))),5)
    }else if(!is.na(all_SMA5[temp_date_i-1])){
      all_EMA5[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/6) + all_SMA5[temp_date_i-1] * (1 - (2/6))),5)
    }else{
      all_SMA5[temp_date_i] <- round(mean(all_rates[all_dates[(temp_date_i-4):temp_date_i],"DFF"]),5)
    }
    if(temp_date_i > 9){
      if(!is.na(all_EMA10[temp_date_i-1])){
        all_EMA10[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/11) + all_EMA10[temp_date_i-1] * (1 - (2/11))),5)
      }else if(!is.na(all_SMA10[temp_date_i-1])){
        all_EMA10[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/11) + all_SMA10[temp_date_i-1] * (1 - (2/11))),5)
      }else{
        all_SMA10[temp_date_i] <- round(mean(all_rates[all_dates[(temp_date_i-9):temp_date_i],"DFF"]),5)
      }
    }
    if(temp_date_i > 19){
      if(!is.na(all_EMA20[temp_date_i-1])){
        all_EMA20[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/21) + all_EMA20[temp_date_i-1] * (1 - (2/21))),5)
      }else if(!is.na(all_SMA20[temp_date_i-1])){
        all_EMA20[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/21) + all_SMA20[temp_date_i-1] * (1 - (2/21))),5)
      }else{
        all_SMA20[temp_date_i] <- round(mean(all_rates[all_dates[(temp_date_i-19):temp_date_i],"DFF"]),5)
      }
    }
    if(temp_date_i > 49){
      if(!is.na(all_EMA50[temp_date_i-1])){
        all_EMA50[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/51) + all_EMA50[temp_date_i-1] * (1 - (2/51))),5)
      }else if(!is.na(all_SMA50[temp_date_i-1])){
        all_EMA50[temp_date_i] <- round((all_rates[temp_date_i,"DFF"] * (2/51) + all_SMA50[temp_date_i-1] * (1 - (2/51))),5)
      }else{
        all_SMA50[temp_date_i] <- round(mean(all_rates[all_dates[(temp_date_i-49):temp_date_i],"DFF"]),5)
      }
    }
  }
}

rate_df <- as.data.frame(list(date=all_dates,EOD=all_rates$DFF,EMA5=all_EMA5,EMA10=all_EMA10,EMA20=all_EMA20,EMA50=all_EMA50))
saveRDS(rate_df,file="E:/Market_Data/FedRateDF_20000101_to_20240404.RDS")


```

```{r create input for NN modeling}

library(dplyr)
library(stringr)

###Create filtered subset of tickers to start with (e.g. SP500)
SP500_tickers <- readRDS("E:/Market_Data/SP500_tickers_20240404.RDS")
SP500_tickers <- unlist(lapply(SP500_tickers,function(x){str_replace_all(x,"[.]","")}))

###Aggregate together daily, EMA8, and EMA20 data for option aggregates including underlying price
option_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2024-01-22_to_2024-04-04.RDS")
option_aggregate <- option_aggregate[option_aggregate$option_underlying_ticker %in% SP500_tickers,]
option_aggregate <- option_aggregate[option_aggregate$option_quote_date >= "2024-01-22" & option_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_option_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
option_aggregate <- as.data.frame(rbind(temp_aggregate,option_aggregate))
option_aggregate <- option_aggregate[order(option_aggregate$option_underlying_ticker,option_aggregate$option_quote_date),]

EMA5_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2024-01-22_to_2024-04-04.RDS")
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_quote_date >= "2024-01-22" & EMA5_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA5_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
EMA5_aggregate <- as.data.frame(rbind(temp_aggregate,EMA5_aggregate))
EMA5_aggregate <- EMA5_aggregate[order(EMA5_aggregate$option_underlying_ticker,EMA5_aggregate$option_quote_date),]

EMA10_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2024-01-22_to_2024-04-04.RDS")
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_quote_date >= "2024-01-22" & EMA10_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA10_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
EMA10_aggregate <- as.data.frame(rbind(temp_aggregate,EMA10_aggregate))
EMA10_aggregate <- EMA10_aggregate[order(EMA10_aggregate$option_underlying_ticker,EMA10_aggregate$option_quote_date),]

EMA20_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2024-01-22_to_2024-04-04.RDS")
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_quote_date >= "2024-01-22" & EMA20_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA20_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
EMA20_aggregate <- as.data.frame(rbind(temp_aggregate,EMA20_aggregate))
EMA20_aggregate <- EMA20_aggregate[order(EMA20_aggregate$option_underlying_ticker,EMA20_aggregate$option_quote_date),]

EMA50_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2024-01-22_to_2024-04-04.RDS")
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_quote_date >= "2024-01-22" & EMA50_aggregate$option_quote_date <= "2024-04-04",]
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2023-09-04_to_2024-01-19.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-09-04" & temp_aggregate$option_quote_date <= "2024-01-19",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2023-04-17_to_2023-09-01.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2023-04-17" & temp_aggregate$option_quote_date <= "2023-09-01",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2022-11-28_to_2023-04-14.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-11-28" & temp_aggregate$option_quote_date <= "2023-04-14",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2022-07-11_to_2022-11-25.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-07-11" & temp_aggregate$option_quote_date <= "2022-11-25",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2022-02-21_to_2022-07-08.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2022-02-21" & temp_aggregate$option_quote_date <= "2022-07-08",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2021-10-01_to_2022-02-18.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-10-01" & temp_aggregate$option_quote_date <= "2022-02-18",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
temp_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/EMA50_aggregate_2021-05-14_to_2021-09-30.RDS")
temp_aggregate <- temp_aggregate[temp_aggregate$option_underlying_ticker %in% SP500_tickers,]
temp_aggregate <- temp_aggregate[temp_aggregate$option_quote_date >= "2021-05-14" & temp_aggregate$option_quote_date <= "2021-09-30",]
EMA50_aggregate <- as.data.frame(rbind(temp_aggregate,EMA50_aggregate))
EMA50_aggregate <- EMA50_aggregate[order(EMA50_aggregate$option_underlying_ticker,EMA50_aggregate$option_quote_date),]

###Remove dates surrounding stock splits
SP500_splits <- readRDS("E:/Market_Data/SP500_splits_20240408.RDS")

for(temp_split_i in 1:length(SP500_splits)){
  temp_ticker <- SP500_splits$ticker[temp_split_i]
  temp_date <- as.Date(SP500_splits$date[temp_split_i])
  temp_dates <- seq(from = temp_date-10, to = temp_date+10, by = "day")
  option_aggregate[option_aggregate$option_underlying_ticker != temp_ticker | !(option_aggregate$option_quote_date %in% temp_dates),]
  EMA5_aggregate[EMA5_aggregate$option_underlying_ticker != temp_ticker | !(EMA5_aggregate$option_quote_date %in% temp_dates),]
  EMA10_aggregate[EMA10_aggregate$option_underlying_ticker != temp_ticker | !(EMA10_aggregate$option_quote_date %in% temp_dates),]
  EMA20_aggregate[EMA20_aggregate$option_underlying_ticker != temp_ticker | !(EMA20_aggregate$option_quote_date %in% temp_dates),]
  EMA50_aggregate[EMA50_aggregate$option_underlying_ticker != temp_ticker | !(EMA50_aggregate$option_quote_date %in% temp_dates),]
}

##Match dates across datasets and retain only those with data for all
match_dates <- unique(EMA50_aggregate$option_quote_date)
temp_dates <- unique(EMA20_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(EMA10_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(EMA5_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(option_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
option_aggregate <- option_aggregate[option_aggregate$option_quote_date %in% match_dates,]
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_quote_date %in% match_dates,]
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_quote_date %in% match_dates,]
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_quote_date %in% match_dates,]
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_quote_date %in% match_dates,]

###Make columns unique across datasets and merge
colnames(option_aggregate) <- paste0("EOD_",colnames(option_aggregate))
colnames(EMA5_aggregate) <- paste0("EMA5_",colnames(EMA5_aggregate))
colnames(EMA10_aggregate) <- paste0("EMA10_",colnames(EMA10_aggregate))
colnames(EMA20_aggregate) <- paste0("EMA20_",colnames(EMA20_aggregate))
colnames(EMA50_aggregate) <- paste0("EMA50_",colnames(EMA50_aggregate))
rownames(option_aggregate) <- paste0(option_aggregate$EOD_option_underlying_ticker,"_",
                                     format(option_aggregate$EOD_option_quote_date, format = "%Y%m%d"))
rownames(EMA5_aggregate) <- paste0(EMA5_aggregate$EMA5_option_underlying_ticker,"_",
                                     format(EMA5_aggregate$EMA5_option_quote_date, format = "%Y%m%d"))
rownames(EMA10_aggregate) <- paste0(EMA10_aggregate$EMA10_option_underlying_ticker,"_",
                                     format(EMA10_aggregate$EMA10_option_quote_date, format = "%Y%m%d"))
rownames(EMA20_aggregate) <- paste0(EMA20_aggregate$EMA20_option_underlying_ticker,"_",
                                     format(EMA20_aggregate$EMA20_option_quote_date, format = "%Y%m%d"))
rownames(EMA50_aggregate) <- paste0(EMA50_aggregate$EMA50_option_underlying_ticker,"_",
                                     format(EMA50_aggregate$EMA50_option_quote_date, format = "%Y%m%d"))

merge_aggregate <- as.data.frame(cbind(option_aggregate,
                                       EMA5_aggregate[rownames(option_aggregate),
                                                      !(colnames(EMA5_aggregate) %in% c("EMA5_option_underlying_ticker","EMA5_option_quote_date"))],
                                       EMA10_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA10_aggregate) %in% c("EMA10_option_underlying_ticker","EMA10_option_quote_date"))],
                                       EMA20_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA20_aggregate) %in% c("EMA20_option_underlying_ticker","EMA20_option_quote_date"))],
                                       EMA50_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA50_aggregate) %in% c("EMA50_option_underlying_ticker","EMA50_option_quote_date"))]))

###Merge with outcomes
full_outcomes <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/full_outcomesV2_20210514_to_20240404.RDS")
colnames(full_outcomes) <- paste0("outcomes_",colnames(full_outcomes))
rownames(full_outcomes) <- paste0(full_outcomes$outcomes_option_underlying_ticker,"_",
                                     format(full_outcomes$outcomes_option_quote_date, format = "%Y%m%d"))
full_outcomes <- full_outcomes[rownames(full_outcomes) %in% rownames(merge_aggregate),]
merge_aggregate <- as.data.frame(cbind(merge_aggregate,
                                       full_outcomes[rownames(merge_aggregate),
                                                      !(colnames(full_outcomes) %in% c("outcomes_option_underlying_ticker","outcomes_option_quote_date"))]))

###Add in daily interest rate for each date
all_rates <- readRDS("E:/Market_Data/FedRateDF_20000101_to_20240404.RDS")
colnames(all_rates) <- paste0(colnames(all_rates),"_FedInterestRate")
rownames(all_rates) <- all_rates$date_FedInterestRate
temp_dates <- format(merge_aggregate$EOD_option_quote_date, format = "%Y-%m-%d")
merge_aggregate$EOD_FedInterestRate <- all_rates[temp_dates,"EOD_FedInterestRate"]
merge_aggregate$EMA5_FedInterestRate <- all_rates[temp_dates,"EMA5_FedInterestRate"]
merge_aggregate$EMA10_FedInterestRate <- all_rates[temp_dates,"EMA10_FedInterestRate"]
merge_aggregate$EMA20_FedInterestRate <- all_rates[temp_dates,"EMA20_FedInterestRate"]
merge_aggregate$EMA50_FedInterestRate <- all_rates[temp_dates,"EMA50_FedInterestRate"]

###Add sectors
all_sectors <- readRDS("E:/Market_Data/SP500_sectors_20240404.RDS")
all_sectors$Symbol[all_sectors$Symbol == "BRK.B"] = "BRKB"
all_sectors$Symbol[all_sectors$Symbol == "BF.B"] = "BFB"
rownames(all_sectors) <- all_sectors$Symbol
merge_aggregate$underlying_stock_sector_ <- all_sectors[merge_aggregate$EOD_option_underlying_ticker,"Sector"]
temp_dummies <- model.matrix(~ underlying_stock_sector_ - 1, data = merge_aggregate)  # The '-1' omits the intercept
colnames(temp_dummies) <- unlist(lapply(colnames(temp_dummies),function(x){str_replace_all(x," ","_")}))

# Convert matrix to a dataframe and concatenate with the original dataframe
merge_aggregate <- cbind(merge_aggregate, as.data.frame(temp_dummies))
merge_aggregate$underlying_stock_sector_ <- NULL
saveRDS(merge_aggregate,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/prefilter_merged_aggregate_for_NN_20210514_to_20240404.RDS")
##Remove rows with any NA values
merge_aggregate <- merge_aggregate[rowSums(is.na(merge_aggregate)) == 0,]
saveRDS(merge_aggregate,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/merged_aggregate_for_NN_20210514_to_20240404.RDS")

merge_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/merged_aggregate_for_NN_20210514_to_20240404.RDS")
test_input <- merge_aggregate[,grepl("_volume_",colnames(merge_aggregate)) | 
                                          grepl("_open_interest_",colnames(merge_aggregate))]
test_input <- test_input + 1
temp_logic <- grepl("EOD_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA5_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA10_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA20_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA50_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
test_input <- log10(test_input)
robustScalerFxn <- function(x){
    x <- ((x - median(x)) / IQR(x))
}
test_input <- test_input %>%
    mutate(across(everything(), robustScalerFxn))

extra_input <- merge_aggregate[,grepl("_FedInterestRate",colnames(merge_aggregate))]
test_input <- cbind(test_input,extra_input)
test_input <- round(test_input,3)
extra_input <- merge_aggregate[,grepl("underlying_stock_sector_",colnames(merge_aggregate))]
test_input <- cbind(test_input,extra_input)

###Create NN test input and output datasets
#test_input = as.matrix(merge_aggregate[,!(colnames(merge_aggregate) %in% 
#                                            c("EOD_option_underlying_ticker",
#                                              "EOD_option_quote_date",
#                                              colnames(merge_aggregate)[grepl("outcomes_",colnames(merge_aggregate))],
#                                              colnames(merge_aggregate)[grepl("_listings_",colnames(merge_aggregate))]))])

#write.table(t(test_input),file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/test_input_for_NN_20210514_to_20240404.tsv",sep="\t")
write.table(t(test_input),file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_inputV2_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase2 > 0 | 
                         merge_aggregate$outcomes_time2_increase2 > 0 | 
                         merge_aggregate$outcomes_time3_increase2 > 0 | 
                         merge_aggregate$outcomes_time4_increase2 > 0 | 
                         merge_aggregate$outcomes_time5_increase2 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_2up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase5 > 0 | 
                         merge_aggregate$outcomes_time2_increase5 > 0 | 
                         merge_aggregate$outcomes_time3_increase5 > 0 | 
                         merge_aggregate$outcomes_time4_increase5 > 0 | 
                         merge_aggregate$outcomes_time5_increase5 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_5up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease2 > 0 | 
                         merge_aggregate$outcomes_time2_decrease2 > 0 | 
                         merge_aggregate$outcomes_time3_decrease2 > 0 | 
                         merge_aggregate$outcomes_time4_decrease2 > 0 | 
                         merge_aggregate$outcomes_time5_decrease2 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_2down5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease5 > 0 | 
                         merge_aggregate$outcomes_time2_decrease5 > 0 | 
                         merge_aggregate$outcomes_time3_decrease5 > 0 | 
                         merge_aggregate$outcomes_time4_decrease5 > 0 | 
                         merge_aggregate$outcomes_time5_decrease5 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_5down5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase2 > 0 | 
                         merge_aggregate$outcomes_time2_increase2 > 0 | 
                         merge_aggregate$outcomes_time3_increase2 > 0 | 
                         merge_aggregate$outcomes_time4_increase2 > 0 | 
                         merge_aggregate$outcomes_time5_increase2 > 0 | 
                         merge_aggregate$outcomes_time6_increase2 > 0 | 
                         merge_aggregate$outcomes_time7_increase2 > 0 | 
                         merge_aggregate$outcomes_time8_increase2 > 0 | 
                         merge_aggregate$outcomes_time9_increase2 > 0 | 
                         merge_aggregate$outcomes_time10_increase2 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_2up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase5 > 0 | 
                         merge_aggregate$outcomes_time2_increase5 > 0 | 
                         merge_aggregate$outcomes_time3_increase5 > 0 | 
                         merge_aggregate$outcomes_time4_increase5 > 0 | 
                         merge_aggregate$outcomes_time5_increase5 > 0 | 
                         merge_aggregate$outcomes_time6_increase5 > 0 | 
                         merge_aggregate$outcomes_time7_increase5 > 0 | 
                         merge_aggregate$outcomes_time8_increase5 > 0 | 
                         merge_aggregate$outcomes_time9_increase5 > 0 | 
                         merge_aggregate$outcomes_time10_increase5 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_5up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease2 > 0 | 
                         merge_aggregate$outcomes_time2_decrease2 > 0 | 
                         merge_aggregate$outcomes_time3_decrease2 > 0 | 
                         merge_aggregate$outcomes_time4_decrease2 > 0 | 
                         merge_aggregate$outcomes_time5_decrease2 > 0 | 
                         merge_aggregate$outcomes_time6_decrease2 > 0 | 
                         merge_aggregate$outcomes_time7_decrease2 > 0 | 
                         merge_aggregate$outcomes_time8_decrease2 > 0 | 
                         merge_aggregate$outcomes_time9_decrease2 > 0 | 
                         merge_aggregate$outcomes_time10_decrease2 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_2down10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease5 > 0 | 
                         merge_aggregate$outcomes_time2_decrease5 > 0 | 
                         merge_aggregate$outcomes_time3_decrease5 > 0 | 
                         merge_aggregate$outcomes_time4_decrease5 > 0 | 
                         merge_aggregate$outcomes_time5_decrease5 > 0 | 
                         merge_aggregate$outcomes_time6_decrease5 > 0 | 
                         merge_aggregate$outcomes_time7_decrease5 > 0 | 
                         merge_aggregate$outcomes_time8_decrease5 > 0 | 
                         merge_aggregate$outcomes_time9_decrease5 > 0 | 
                         merge_aggregate$outcomes_time10_decrease5 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_5down10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease10 > 0 | 
                         merge_aggregate$outcomes_time2_decrease10 > 0 | 
                         merge_aggregate$outcomes_time3_decrease10 > 0 | 
                         merge_aggregate$outcomes_time4_decrease10 > 0 | 
                         merge_aggregate$outcomes_time5_decrease10 > 0 | 
                         merge_aggregate$outcomes_time6_decrease10 > 0 | 
                         merge_aggregate$outcomes_time7_decrease10 > 0 | 
                         merge_aggregate$outcomes_time8_decrease10 > 0 | 
                         merge_aggregate$outcomes_time9_decrease10 > 0 | 
                         merge_aggregate$outcomes_time10_decrease10 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_10down10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase10 > 0 | 
                         merge_aggregate$outcomes_time2_increase10 > 0 | 
                         merge_aggregate$outcomes_time3_increase10 > 0 | 
                         merge_aggregate$outcomes_time4_increase10 > 0 | 
                         merge_aggregate$outcomes_time5_increase10 > 0 | 
                         merge_aggregate$outcomes_time6_increase10 > 0 | 
                         merge_aggregate$outcomes_time7_increase10 > 0 | 
                         merge_aggregate$outcomes_time8_increase10 > 0 | 
                         merge_aggregate$outcomes_time9_increase10 > 0 | 
                         merge_aggregate$outcomes_time10_increase10 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_10up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_decrease075 > 0 | 
                         merge_aggregate$outcomes_time2_decrease075 > 0 | 
                         merge_aggregate$outcomes_time3_decrease075 > 0 | 
                         merge_aggregate$outcomes_time4_decrease075 > 0 | 
                         merge_aggregate$outcomes_time5_decrease075 > 0 | 
                         merge_aggregate$outcomes_time6_decrease075 > 0 | 
                         merge_aggregate$outcomes_time7_decrease075 > 0 | 
                         merge_aggregate$outcomes_time8_decrease075 > 0 | 
                         merge_aggregate$outcomes_time9_decrease075 > 0 | 
                         merge_aggregate$outcomes_time10_decrease075 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_075down10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase075 > 0 | 
                         merge_aggregate$outcomes_time2_increase075 > 0 | 
                         merge_aggregate$outcomes_time3_increase075 > 0 | 
                         merge_aggregate$outcomes_time4_increase075 > 0 | 
                         merge_aggregate$outcomes_time5_increase075 > 0 | 
                         merge_aggregate$outcomes_time6_increase075 > 0 | 
                         merge_aggregate$outcomes_time7_increase075 > 0 | 
                         merge_aggregate$outcomes_time8_increase075 > 0 | 
                         merge_aggregate$outcomes_time9_increase075 > 0 | 
                         merge_aggregate$outcomes_time10_increase075 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_075up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase7 > 0 | 
                         merge_aggregate$outcomes_time2_increase7 > 0 | 
                         merge_aggregate$outcomes_time3_increase7 > 0 | 
                         merge_aggregate$outcomes_time4_increase7 > 0 | 
                         merge_aggregate$outcomes_time5_increase7 > 0 | 
                         merge_aggregate$outcomes_time6_increase7 > 0 | 
                         merge_aggregate$outcomes_time7_increase7 > 0 | 
                         merge_aggregate$outcomes_time8_increase7 > 0 | 
                         merge_aggregate$outcomes_time9_increase7 > 0 | 
                         merge_aggregate$outcomes_time10_increase7 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_7up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase8 > 0 | 
                         merge_aggregate$outcomes_time2_increase8 > 0 | 
                         merge_aggregate$outcomes_time3_increase8 > 0 | 
                         merge_aggregate$outcomes_time4_increase8 > 0 | 
                         merge_aggregate$outcomes_time5_increase8 > 0 | 
                         merge_aggregate$outcomes_time6_increase8 > 0 | 
                         merge_aggregate$outcomes_time7_increase8 > 0 | 
                         merge_aggregate$outcomes_time8_increase8 > 0 | 
                         merge_aggregate$outcomes_time9_increase8 > 0 | 
                         merge_aggregate$outcomes_time10_increase8 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_8up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase9 > 0 | 
                         merge_aggregate$outcomes_time2_increase9 > 0 | 
                         merge_aggregate$outcomes_time3_increase9 > 0 | 
                         merge_aggregate$outcomes_time4_increase9 > 0 | 
                         merge_aggregate$outcomes_time5_increase9 > 0 | 
                         merge_aggregate$outcomes_time6_increase9 > 0 | 
                         merge_aggregate$outcomes_time7_increase9 > 0 | 
                         merge_aggregate$outcomes_time8_increase9 > 0 | 
                         merge_aggregate$outcomes_time9_increase9 > 0 | 
                         merge_aggregate$outcomes_time10_increase9 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_9up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase025 > 0 | 
                         merge_aggregate$outcomes_time2_increase025 > 0 | 
                         merge_aggregate$outcomes_time3_increase025 > 0 | 
                         merge_aggregate$outcomes_time4_increase025 > 0 | 
                         merge_aggregate$outcomes_time5_increase025 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_025up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase3 > 0 | 
                         merge_aggregate$outcomes_time2_increase3 > 0 | 
                         merge_aggregate$outcomes_time3_increase3 > 0 | 
                         merge_aggregate$outcomes_time4_increase3 > 0 | 
                         merge_aggregate$outcomes_time5_increase3 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_3up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase035 > 0 | 
                         merge_aggregate$outcomes_time2_increase035 > 0 | 
                         merge_aggregate$outcomes_time3_increase035 > 0 | 
                         merge_aggregate$outcomes_time4_increase035 > 0 | 
                         merge_aggregate$outcomes_time5_increase035 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_035up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase4 > 0 | 
                         merge_aggregate$outcomes_time2_increase4 > 0 | 
                         merge_aggregate$outcomes_time3_increase4 > 0 | 
                         merge_aggregate$outcomes_time4_increase4 > 0 | 
                         merge_aggregate$outcomes_time5_increase4 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_4up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time1_increase045 > 0 | 
                         merge_aggregate$outcomes_time2_increase045 > 0 | 
                         merge_aggregate$outcomes_time3_increase045 > 0 | 
                         merge_aggregate$outcomes_time4_increase045 > 0 | 
                         merge_aggregate$outcomes_time5_increase045 > 0)

##Save test input and output data for use in other models
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_045up5d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_df <- merge_aggregate[,grepl("_total_change",colnames(merge_aggregate))]
max_10d <- apply(test_df, MARGIN = 1, max)
##Save test input and output data for use in other models
write.table(max_10d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_maxChange10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_df <- test_df[,colnames(test_df) %in% c("outcomes_time1_total_change",
                                             "outcomes_time2_total_change",
                                             "outcomes_time3_total_change",
                                             "outcomes_time4_total_change",
                                             "outcomes_time5_total_change")]
max_5d <- apply(test_df, MARGIN = 1, max)
##Save test input and output data for use in other models
write.table(max_5d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_maxChange5d_for_NN_20210514_to_20240404.tsv",sep="\t")

change_1d <- merge_aggregate$outcomes_time1_total_change
write.table(change_1d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change1d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_2d <- merge_aggregate$outcomes_time2_total_change
write.table(change_2d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change2d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_3d <- merge_aggregate$outcomes_time3_total_change
write.table(change_3d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change3d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_4d <- merge_aggregate$outcomes_time4_total_change
write.table(change_4d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change4d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_5d <- merge_aggregate$outcomes_time5_total_change
write.table(change_5d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change5d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_6d <- merge_aggregate$outcomes_time6_total_change
write.table(change_6d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change6d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_7d <- merge_aggregate$outcomes_time7_total_change
write.table(change_7d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change7d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_8d <- merge_aggregate$outcomes_time8_total_change
write.table(change_8d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change8d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_9d <- merge_aggregate$outcomes_time9_total_change
write.table(change_9d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change9d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_10d <- merge_aggregate$outcomes_time10_total_change
write.table(change_10d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change10d_for_NN_20210514_to_20240404.tsv",sep="\t")
change_11d <- merge_aggregate$outcomes_time11_total_change
write.table(change_11d,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_change10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time10_total_change > 1.09)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_9up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time10_total_change > 1.07)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_7up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time10_total_change > 1.05)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_5up10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time10_total_change < 0.95)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_5down10d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time11_total_change > 1.09)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_9up11d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time11_total_change > 1.07)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_7up11d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time11_total_change > 1.05)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_5up11d_for_NN_20210514_to_20240404.tsv",sep="\t")

test_group = as.factor(merge_aggregate$outcomes_time11_total_change < 0.95)
test_output = as.numeric(test_group)-1
write.table(test_output,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/test_output_new_5down11d_for_NN_20210514_to_20240404.tsv",sep="\t")


```

```{r evaluate testing data results}

```

```{r prepare prediction and interpret result}

###Prepare data for input to prediction
library(dplyr)
library(stringr)

###Create filtered subset of tickers to start with (e.g. SP500)
SP500_tickers <- readRDS("E:/Market_Data/SP500_tickers_20240404.RDS")
SP500_tickers <- unlist(lapply(SP500_tickers,function(x){str_replace_all(x,"[.]","")}))

###Aggregate together daily, EMA8, and EMA20 data for option aggregates including underlying price
option_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/full_option_aggregate_2024-01-22_to_2024-04-09.RDS")
option_aggregate <- option_aggregate[option_aggregate$option_underlying_ticker %in% SP500_tickers,]
option_aggregate <- option_aggregate[option_aggregate$option_quote_date >= "2024-01-22" & option_aggregate$option_quote_date <= "2024-04-09",]
option_aggregate <- option_aggregate[order(option_aggregate$option_underlying_ticker,option_aggregate$option_quote_date),]

EMA5_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/EMA5_aggregate_2024-01-22_to_2024-04-09.RDS")
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_quote_date >= "2024-01-22" & EMA5_aggregate$option_quote_date <= "2024-04-09",]
EMA5_aggregate <- EMA5_aggregate[order(EMA5_aggregate$option_underlying_ticker,EMA5_aggregate$option_quote_date),]

EMA10_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/EMA10_aggregate_2024-01-22_to_2024-04-09.RDS")
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_quote_date >= "2024-01-22" & EMA10_aggregate$option_quote_date <= "2024-04-09",]
EMA10_aggregate <- EMA10_aggregate[order(EMA10_aggregate$option_underlying_ticker,EMA10_aggregate$option_quote_date),]

EMA20_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/EMA20_aggregate_2024-01-22_to_2024-04-09.RDS")
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_quote_date >= "2024-01-22" & EMA20_aggregate$option_quote_date <= "2024-04-09",]
EMA20_aggregate <- EMA20_aggregate[order(EMA20_aggregate$option_underlying_ticker,EMA20_aggregate$option_quote_date),]

EMA50_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/EMA50_aggregate_2024-01-22_to_2024-04-09.RDS")
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_underlying_ticker %in% SP500_tickers,]
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_quote_date >= "2024-01-22" & EMA50_aggregate$option_quote_date <= "2024-04-09",]
EMA50_aggregate <- EMA50_aggregate[order(EMA50_aggregate$option_underlying_ticker,EMA50_aggregate$option_quote_date),]

###Remove dates surrounding stock splits
SP500_splits <- readRDS("E:/Market_Data/SP500_splits_20240409.RDS")

for(temp_split_i in 1:length(SP500_splits)){
  temp_ticker <- SP500_splits$ticker[temp_split_i]
  temp_date <- as.Date(SP500_splits$date[temp_split_i])
  temp_dates <- seq(from = temp_date-10, to = temp_date+10, by = "day")
  option_aggregate[option_aggregate$option_underlying_ticker != temp_ticker | !(option_aggregate$option_quote_date %in% temp_dates),]
  EMA5_aggregate[EMA5_aggregate$option_underlying_ticker != temp_ticker | !(EMA5_aggregate$option_quote_date %in% temp_dates),]
  EMA10_aggregate[EMA10_aggregate$option_underlying_ticker != temp_ticker | !(EMA10_aggregate$option_quote_date %in% temp_dates),]
  EMA20_aggregate[EMA20_aggregate$option_underlying_ticker != temp_ticker | !(EMA20_aggregate$option_quote_date %in% temp_dates),]
  EMA50_aggregate[EMA50_aggregate$option_underlying_ticker != temp_ticker | !(EMA50_aggregate$option_quote_date %in% temp_dates),]
}

##Match dates across datasets and retain only those with data for all
match_dates <- unique(EMA50_aggregate$option_quote_date)
temp_dates <- unique(EMA20_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(EMA10_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(EMA5_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
temp_dates <- unique(option_aggregate$option_quote_date)
match_dates <- match_dates[match_dates %in% temp_dates]
option_aggregate <- option_aggregate[option_aggregate$option_quote_date %in% match_dates,]
EMA5_aggregate <- EMA5_aggregate[EMA5_aggregate$option_quote_date %in% match_dates,]
EMA10_aggregate <- EMA10_aggregate[EMA10_aggregate$option_quote_date %in% match_dates,]
EMA20_aggregate <- EMA20_aggregate[EMA20_aggregate$option_quote_date %in% match_dates,]
EMA50_aggregate <- EMA50_aggregate[EMA50_aggregate$option_quote_date %in% match_dates,]

###Make columns unique across datasets and merge
colnames(option_aggregate) <- paste0("EOD_",colnames(option_aggregate))
colnames(EMA5_aggregate) <- paste0("EMA5_",colnames(EMA5_aggregate))
colnames(EMA10_aggregate) <- paste0("EMA10_",colnames(EMA10_aggregate))
colnames(EMA20_aggregate) <- paste0("EMA20_",colnames(EMA20_aggregate))
colnames(EMA50_aggregate) <- paste0("EMA50_",colnames(EMA50_aggregate))
rownames(option_aggregate) <- paste0(option_aggregate$EOD_option_underlying_ticker,"_",
                                     format(option_aggregate$EOD_option_quote_date, format = "%Y%m%d"))
rownames(EMA5_aggregate) <- paste0(EMA5_aggregate$EMA5_option_underlying_ticker,"_",
                                     format(EMA5_aggregate$EMA5_option_quote_date, format = "%Y%m%d"))
rownames(EMA10_aggregate) <- paste0(EMA10_aggregate$EMA10_option_underlying_ticker,"_",
                                     format(EMA10_aggregate$EMA10_option_quote_date, format = "%Y%m%d"))
rownames(EMA20_aggregate) <- paste0(EMA20_aggregate$EMA20_option_underlying_ticker,"_",
                                     format(EMA20_aggregate$EMA20_option_quote_date, format = "%Y%m%d"))
rownames(EMA50_aggregate) <- paste0(EMA50_aggregate$EMA50_option_underlying_ticker,"_",
                                     format(EMA50_aggregate$EMA50_option_quote_date, format = "%Y%m%d"))

merge_aggregate <- as.data.frame(cbind(option_aggregate,
                                       EMA5_aggregate[rownames(option_aggregate),
                                                      !(colnames(EMA5_aggregate) %in% c("EMA5_option_underlying_ticker","EMA5_option_quote_date"))],
                                       EMA10_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA10_aggregate) %in% c("EMA10_option_underlying_ticker","EMA10_option_quote_date"))],
                                       EMA20_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA20_aggregate) %in% c("EMA20_option_underlying_ticker","EMA20_option_quote_date"))],
                                       EMA50_aggregate[rownames(option_aggregate),
                                                       !(colnames(EMA50_aggregate) %in% c("EMA50_option_underlying_ticker","EMA50_option_quote_date"))]))


###Add in daily interest rate for each date
all_rates <- readRDS("E:/Market_Data/FedRateDF_20000101_to_20240405_mod.RDS")
colnames(all_rates) <- paste0(colnames(all_rates),"_FedInterestRate")
rownames(all_rates) <- all_rates$date_FedInterestRate
temp_dates <- format(merge_aggregate$EOD_option_quote_date, format = "%Y-%m-%d")
merge_aggregate$EOD_FedInterestRate <- all_rates[temp_dates,"EOD_FedInterestRate"]
merge_aggregate$EMA5_FedInterestRate <- all_rates[temp_dates,"EMA5_FedInterestRate"]
merge_aggregate$EMA10_FedInterestRate <- all_rates[temp_dates,"EMA10_FedInterestRate"]
merge_aggregate$EMA20_FedInterestRate <- all_rates[temp_dates,"EMA20_FedInterestRate"]
merge_aggregate$EMA50_FedInterestRate <- all_rates[temp_dates,"EMA50_FedInterestRate"]

###Add sectors
all_sectors <- readRDS("E:/Market_Data/SP500_sectors_20240404.RDS")
all_sectors$Symbol[all_sectors$Symbol == "BRK.B"] = "BRKB"
all_sectors$Symbol[all_sectors$Symbol == "BF.B"] = "BFB"
rownames(all_sectors) <- all_sectors$Symbol
merge_aggregate$underlying_stock_sector_ <- all_sectors[merge_aggregate$EOD_option_underlying_ticker,"Sector"]
temp_dummies <- model.matrix(~ underlying_stock_sector_ - 1, data = merge_aggregate)  # The '-1' omits the intercept
colnames(temp_dummies) <- unlist(lapply(colnames(temp_dummies),function(x){str_replace_all(x," ","_")}))

# Convert matrix to a dataframe and concatenate with the original dataframe
merge_aggregate <- cbind(merge_aggregate, as.data.frame(temp_dummies))
merge_aggregate$underlying_stock_sector_ <- NULL
#saveRDS(merge_aggregate,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/prefilter_merged_aggregate_for_NN_20210514_to_20240404.RDS")
##Remove rows with any NA values
merge_aggregate <- merge_aggregate[rowSums(is.na(merge_aggregate)) == 0,]
#saveRDS(merge_aggregate,file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/merged_aggregate_for_NN_20210514_to_20240404.RDS")

#merge_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/merged_aggregate_for_NN_20210514_to_20240404.RDS")
test_input <- merge_aggregate[,grepl("_volume_",colnames(merge_aggregate)) | 
                                          grepl("_open_interest_",colnames(merge_aggregate))]
test_input <- test_input + 1
temp_logic <- grepl("EOD_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA5_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA10_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA20_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
temp_logic <- grepl("EMA50_",colnames(test_input))
test_input[,temp_logic] <- test_input[,temp_logic] / rowSums(test_input[,temp_logic])
test_input <- log10(test_input)
robustScalerFxn <- function(x){
    x <- ((x - median(x)) / IQR(x))
}
test_input <- test_input %>%
    mutate(across(everything(), robustScalerFxn))

extra_input <- merge_aggregate[,grepl("_FedInterestRate",colnames(merge_aggregate))]
test_input <- cbind(test_input,extra_input)
test_input <- round(test_input,3)
extra_input <- merge_aggregate[,grepl("underlying_stock_sector_",colnames(merge_aggregate))]
test_input <- cbind(test_input,extra_input)

filtered_aggregate <- readRDS("E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/Freeze20240404/merged_aggregate_for_NN_20210514_to_20240404.RDS")
last_training_date <- max(filtered_aggregate$EOD_option_quote_date)
test_input <- test_input[merge_aggregate$EOD_option_quote_date > last_training_date,]
write.table(t(test_input),file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/test_input_for_prediction_with_NN_20240314_to_20240409.tsv",sep="\t")


###Create NN test input and output datasets
#test_input = as.matrix(merge_aggregate[,!(colnames(merge_aggregate) %in% 
#                                            c("EOD_option_underlying_ticker",
#                                              "EOD_option_quote_date",
#                                              colnames(merge_aggregate)[grepl("outcomes_",colnames(merge_aggregate))],
#                                              colnames(merge_aggregate)[grepl("_listings_",colnames(merge_aggregate))]))])

#write.table(t(test_input),file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/test_input_for_NN_20210514_to_20240404.tsv",sep="\t")
#write.table(t(test_input),file="E:/Market_Data/DiscountOptionData/DTNSubscription/revised_derived_aggregates/test_inputV2_for_NN_20210514_to_20240404.tsv",sep="\t")

###Read in prediction and merge with input

###For each day
###1. Retrieve followup stock data for predicted tickers and add to prediction df
###2. Plot ticker data across 10+ day timecourse


```


Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.
